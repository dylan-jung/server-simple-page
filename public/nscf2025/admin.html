<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í–‰ì‚¬ í˜ì´ì§€ ê´€ë¦¬ì</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .container {
      max-width: 1080px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      padding: 18px 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card h3 {
      margin-top: 16px;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }

    .card small {
      color: #9ca3af;
      font-size: 0.8rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1;
      min-width: 120px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5e7eb;
      color: #4b5563;
      margin-left: 4px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: #111827;
      color: #ffffff;
      margin-top: 10px;
    }

    .btn.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    .btn + .btn {
      margin-left: 6px;
    }

    .chip {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      margin-left: 4px;
    }

    .item-list {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 10px;
      margin-top: 8px;
      background: #f9fafb;
    }

    .item {
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .item-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #374151;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      font-size: 0.8rem;
    }

    input[type="checkbox"] {
      transform: scale(1.1);
    }

    .status {
      margin-top: 12px;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .status strong {
      color: #111827;
    }

    .danger {
      color: #b91c1c;
    }

    @media (min-width: 768px) {
      .card {
        padding: 20px 18px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>í–‰ì‚¬ í˜ì´ì§€ ê´€ë¦¬ì</h1>

    <div class="card">
      <h2>ê¸°ë³¸ ì •ë³´</h2>
      <label>í–‰ì‚¬ ì œëª©</label>
      <input type="text" id="title" />


    </div>

    <div class="card">
      <h2>í¬ìŠ¤í„°</h2>
      <label>í¬ìŠ¤í„° ì´ë¯¸ì§€ URL</label>
      <input type="text" id="posterUrl" placeholder="ì˜ˆ: https://..." />

    </div>

    <div class="card">
      <h2>ğŸ“‚ ë°œí‘œìë£Œ</h2>

      <h3>ë°œí‘œìë£Œ ë²„íŠ¼ ëª©ë¡ <span class="chip">slides ë°°ì—´</span></h3>
      <small>ë²„íŠ¼ì„ ì—¬ëŸ¬ ê°œ ë‘˜ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: PDF, PPT)</small>

      <div class="item-list" id="slidesList"></div>
      <button class="btn small secondary" type="button" id="addSlideBtn">+ ë²„íŠ¼ ì¶”ê°€</button>
    </div>

    <div class="card">
      <h2>ğŸ¥ ë…¹í™” ì˜ìƒ</h2>


      <div class="row">
        <div>
          <label>ìœ íŠœë¸Œ ì˜ìƒ ID</label>
          <input type="text" id="youtubeId" placeholder="ì˜ˆ: https://youtu.be/abcd1234 â†’ abcd1234" />
        </div>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“¸ ì‚¬ì§„ì²©</h2>
      
      <h3>ì‚¬ì§„ ëª©ë¡ <span class="chip">photos ë°°ì—´</span></h3>
      <small>ê° í•­ëª©ì€ ì¸ë„¤ì¼/ì›ë³¸ URLì„ ë§í¬ë¡œ ë„£ì–´ ì£¼ì„¸ìš”.</small>

      <div class="item-list" id="photosList"></div>
      <button class="btn small secondary" type="button" id="addPhotoBtn">+ ì‚¬ì§„ ì¶”ê°€</button>
    </div>

    <div class="card">
        <h2>ğŸ”— ë§í¬ ê´€ë¦¬</h2>
        
        <h3>ë§í¬ ëª©ë¡ <span class="chip">links ë°°ì—´</span></h3>
        <small>ì™¸ë¶€ ë§í¬ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>

        <div class="item-list" id="linksList"></div>
        <button class="btn small secondary" type="button" id="addLinkBtn">+ ë§í¬ ì¶”ê°€</button>
    </div>

    <div class="card">
        <h2>ğŸ“„ ì•„í‹°í´ ê´€ë¦¬</h2>
        
        <h3>ì•„í‹°í´ ëª©ë¡ <span class="chip">articles ë°°ì—´</span></h3>
        <small>ê´€ë ¨ ê¸°ì‚¬ë‚˜ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ë§í¬ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>

        <div class="item-list" id="articlesList"></div>
        <button class="btn small secondary" type="button" id="addArticleBtn">+ ì•„í‹°í´ ì¶”ê°€</button>
    </div>

    <div class="card">
        <h2>ğŸ’¾ ì €ì¥</h2>
        <button class="btn" type="button" id="saveServerBtn">ì„œë²„ì— ì €ì¥í•˜ê¸°</button>
        <p class="subtitle">* ì„œë²„ì— ì €ì¥í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë³€ê²½ì‚¬í•­ì´ ì ìš©ë©ë‹ˆë‹¤.</p>
        <p class="status" id="status"></p>
    </div>

    <hr />

    <div class="card">
      <h2>ğŸ“Š ì„¤ë¬¸ì¡°ì‚¬ ê²°ê³¼</h2>
      <p class="subtitle">ì œì¶œëœ ì„¤ë¬¸ì¡°ì‚¬ ì‘ë‹µì„ ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.</p>
      
      <div class="row">
        <div>
          <label>ì‘ë‹µ ìˆ˜: <span id="responseCount">...</span></label>
        </div>
      </div>
      
      <button class="btn" type="button" id="downloadExcelBtn">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
      <p class="status" id="excelStatus"></p>
    </div>
  </div>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <script>
    const statusEl = document.getElementById('status');

    function setStatus(msg, isError = false) {
      statusEl.innerHTML = isError ? '<span class="danger">' + msg + '</span>' : msg;
    }

    // --- slides / photos í•­ëª© DOM ìƒì„± í—¬í¼ ---
    function createSlideItem(slide, index, onRemove) {
      const div = document.createElement('div');
      div.className = 'item';

      div.innerHTML = `
        <div class="item-header">
          <div class="item-title">ë²„íŠ¼ #${index + 1}</div>
          <button type="button" class="btn small secondary">ì‚­ì œ</button>
        </div>
        <label>ë¼ë²¨ (ë²„íŠ¼ ê¸€ì)</label>
        <input type="text" class="slide-label" value="${slide.label || ''}" />

        <label>íŒŒì¼/ë§í¬ URL</label>
        <input type="text" class="slide-url" value="${slide.url || ''}" />


      `;

      const removeBtn = div.querySelector('button');
      removeBtn.addEventListener('click', onRemove);

      return div;
    }

    function createPhotoItem(photo, index, onRemove) {
      const div = document.createElement('div');
      div.className = 'item';

      div.innerHTML = `
        <div class="item-header">
          <div class="item-title">ì‚¬ì§„ #${index + 1}</div>
          <button type="button" class="btn small secondary">ì‚­ì œ</button>
        </div>
        <label>ì¸ë„¤ì¼ URL (thumb)</label>
        <input type="text" class="photo-thumb" value="${photo.thumb || ''}" />

        <label>ì›ë³¸ URL (original)</label>
        <input type="text" class="photo-original" value="${photo.original || ''}" />


      `;

      const removeBtn = div.querySelector('button');
      removeBtn.addEventListener('click', onRemove);

      return div;
    }

    function createLinkItem(link, index, onRemove) {
        const div = document.createElement('div');
        div.className = 'item';
  
        div.innerHTML = `
          <div class="item-header">
            <div class="item-title">ë§í¬ #${index + 1}</div>
            <button type="button" class="btn small secondary">ì‚­ì œ</button>
          </div>
          <label>ë¼ë²¨ (Label)</label>
          <input type="text" class="link-label" value="${link.label || ''}" placeholder="ì˜ˆ: Google" />
  
          <label>ë§í¬ (URL)</label>
          <input type="text" class="link-url" value="${link.url || ''}" placeholder="ì˜ˆ: https://google.com" />
        `;
  
        const removeBtn = div.querySelector('button');
        removeBtn.addEventListener('click', onRemove);
  
        return div;
      }

    function createArticleItem(article, index, onRemove) {
        const div = document.createElement('div');
        div.className = 'item';
  
        div.innerHTML = `
          <div class="item-header">
            <div class="item-title">ì•„í‹°í´ #${index + 1}</div>
            <button type="button" class="btn small secondary">ì‚­ì œ</button>
          </div>
          <label>ì¸ë„¤ì¼ URL (Thumb)</label>
          <input type="text" class="article-thumb" value="${article.thumb || ''}" placeholder="ì˜ˆ: https://example.com/image.png" />
  
          <label>ë§í¬ (URL)</label>
          <input type="text" class="article-url" value="${article.url || ''}" placeholder="ì˜ˆ: https://example.com/article" />
        `;
  
        const removeBtn = div.querySelector('button');
        removeBtn.addEventListener('click', onRemove);
  
        return div;
      }

    // --- content.json ë¶ˆëŸ¬ì˜¤ê¸° ---
    async function loadContent() {
      try {
        setStatus('content.jsonì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
        const res = await fetch('content.json?cache=' + Date.now());
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        setStatus('content.json ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');

        // ê¸°ë³¸
        document.getElementById('title').value = data.title || '';


        // í¬ìŠ¤í„°
        document.getElementById('posterUrl').value = data.posterUrl || '';

        // ë°œí‘œìë£Œ

        const slidesList = document.getElementById('slidesList');
        slidesList.innerHTML = '';
        (data.slides || []).forEach((slide, idx) => {
          const item = createSlideItem(slide, idx, () => {
            slidesList.removeChild(item);
            renumberItems(slidesList, 'ë²„íŠ¼');
          });
          slidesList.appendChild(item);
        });

        // ë™ì˜ìƒ 
        document.getElementById('youtubeId').value =
          data.video && data.video.youtubeId ? data.video.youtubeId : '';

        // ë§í¬
        const linksList = document.getElementById('linksList');
        linksList.innerHTML = '';
        (data.links || []).forEach((link, idx) => {
            const item = createLinkItem(link, idx, () => {
                linksList.removeChild(item);
                renumberItems(linksList, 'ë§í¬');
            });
            linksList.appendChild(item);
        });

        // ì•„í‹°í´
        const articlesList = document.getElementById('articlesList');
        articlesList.innerHTML = '';
        (data.articles || []).forEach((article, idx) => {
            const item = createArticleItem(article, idx, () => {
                articlesList.removeChild(item);
                renumberItems(articlesList, 'ì•„í‹°í´');
            });
            articlesList.appendChild(item);
        });

        // ì‚¬ì§„ì²©

        const photosList = document.getElementById('photosList');
        photosList.innerHTML = '';
        (data.photos || []).forEach((photo, idx) => {
          const item = createPhotoItem(photo, idx, () => {
            photosList.removeChild(item);
            renumberItems(photosList, 'ì‚¬ì§„');
          });
          photosList.appendChild(item);
        });
      } catch (err) {
        console.error(err);
        setStatus('content.jsonì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ìœ„ì¹˜ì™€ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.', true);
      }
    }

    function renumberItems(listEl, labelPrefix) {
      Array.from(listEl.querySelectorAll('.item')).forEach((item, idx) => {
        const titleEl = item.querySelector('.item-title');
        if (titleEl) titleEl.textContent = labelPrefix + ' #' + (idx + 1);
      });
    }

    // --- í˜„ì¬ í¼ ë‚´ìš©ì„ JSONìœ¼ë¡œ ë§Œë“¤ê¸° ---
    function collectData() {
      const slidesList = document.getElementById('slidesList');
      const slideItems = Array.from(slidesList.querySelectorAll('.item'));
      const slides = slideItems.map(item => ({
        label: item.querySelector('.slide-label').value,
        url: item.querySelector('.slide-url').value
      }));

      const photosList = document.getElementById('photosList');
      const photoItems = Array.from(photosList.querySelectorAll('.item'));
      const photos = photoItems.map(item => ({
        thumb: item.querySelector('.photo-thumb').value,
        original: item.querySelector('.photo-original').value
      }));

      const youtubeId = document.getElementById('youtubeId').value.trim();

      const linksList = document.getElementById('linksList');
      const linkItems = Array.from(linksList.querySelectorAll('.item'));
      const links = linkItems.map(item => ({
        label: item.querySelector('.link-label').value,
        url: item.querySelector('.link-url').value
      }));

      const data = {
        title: document.getElementById('title').value,
        posterUrl: document.getElementById('posterUrl').value,

        slides,
        links,

        video: {}
      };

      if (youtubeId) data.video.youtubeId = youtubeId;



      data.photos = photos;

      const articlesList = document.getElementById('articlesList');
      const articleItems = Array.from(articlesList.querySelectorAll('.item'));
      const articles = articleItems.map(item => ({
        thumb: item.querySelector('.article-thumb').value,
        url: item.querySelector('.article-url').value
      }));
      data.articles = articles;

      return data;
    }

    // --- í•­ëª© ì¶”ê°€ ë²„íŠ¼ ---
    document.getElementById('addSlideBtn').addEventListener('click', () => {
      const slidesList = document.getElementById('slidesList');
      const index = slidesList.querySelectorAll('.item').length;
      const item = createSlideItem(
        {
          label: '',
          url: ''
        },
        index,
        () => {
          slidesList.removeChild(item);
          renumberItems(slidesList, 'ë²„íŠ¼');
        }
      );
      slidesList.appendChild(item);
      renumberItems(slidesList, 'ë²„íŠ¼');
    });

    document.getElementById('addPhotoBtn').addEventListener('click', () => {
      const photosList = document.getElementById('photosList');
      const index = photosList.querySelectorAll('.item').length;
      const item = createPhotoItem(
        {
          thumb: '',
          original: ''
        },
        index,
        () => {
          photosList.removeChild(item);
          renumberItems(photosList, 'ì‚¬ì§„');
        }
      );
      photosList.appendChild(item);
      photosList.appendChild(item);
      renumberItems(photosList, 'ì‚¬ì§„');
    });

    document.getElementById('addLinkBtn').addEventListener('click', () => {
        const linksList = document.getElementById('linksList');
        const index = linksList.querySelectorAll('.item').length;
        const item = createLinkItem(
          {
            label: '',
            url: ''
          },
          index,
          () => {
            linksList.removeChild(item);
            renumberItems(linksList, 'ë§í¬');
          }
        );
        linksList.appendChild(item);
        renumberItems(linksList, 'ë§í¬');
      });

    document.getElementById('addArticleBtn').addEventListener('click', () => {
        const articlesList = document.getElementById('articlesList');
        const index = articlesList.querySelectorAll('.item').length;
        const item = createArticleItem(
          {
            thumb: '',
            url: ''
          },
          index,
          () => {
            articlesList.removeChild(item);
            renumberItems(articlesList, 'ì•„í‹°í´');
          }
        );
        articlesList.appendChild(item);
        renumberItems(articlesList, 'ì•„í‹°í´');
      });

    async function saveToServer() {
        try {
        setStatus('ì„œë²„ì— ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...');
        const data = collectData();

        const res = await fetch('content.json', {
            method: 'PUT',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify(data, null, 2),
            credentials: 'include' // ğŸ” Basic Auth ì¬ì‚¬ìš©
        });

        if (!res.ok) {
            throw new Error('HTTP ' + res.status);
        }

        setStatus('<strong>ì„œë²„ì— ì €ì¥ ì™„ë£Œ!</strong> (ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”.)');
        } catch (err) {
        console.error(err);
        setStatus('ì„œë²„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message, true);
        }
    }   

    document.getElementById('saveServerBtn').addEventListener('click', saveToServer);

    // --- ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ---
    async function loadSurveyStats() {
      const status = document.getElementById('excelStatus');
      const countEl = document.getElementById('responseCount');
      
      try {
        countEl.textContent = 'í™•ì¸ ì¤‘...';
        // /answers/ directory autoindex json
        const res = await fetch('answers/');
        if (!res.ok) {
           if(res.status === 404) {
             countEl.textContent = '0 (ì €ì¥ì†Œ ì—†ìŒ)';
             return;
           }
           throw new Error('ì‘ë‹µ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        const files = await res.json();
        // autoindex returns a list of objects. filter for .json files
        const jsonFiles = files.filter(f => f.name && f.name.endsWith('.json'));
        countEl.textContent = jsonFiles.length + ' ê±´';
        
      } catch (err) {
        console.error(err);
        countEl.textContent = 'ì—ëŸ¬';
        // status.textContent = 'ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + err.message;
      }
    }

    document.getElementById('downloadExcelBtn').addEventListener('click', async () => {
      const status = document.getElementById('excelStatus');
      status.textContent = 'ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤...';

      try {
        // 1. Get file list
        const res = await fetch('answers/');
        if (!res.ok) throw new Error('ì‘ë‹µ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì´ë‚˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        const files = await res.json();
        const jsonFiles = files.filter(f => f.name && f.name.endsWith('.json'));

        if (jsonFiles.length === 0) {
            status.textContent = 'ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        // 2. Fetch all JSON contents
        const answers = [];
        for (const file of jsonFiles) {
            try {
                const r = await fetch('answers/' + file.name);
                if (r.ok) {
                    const data = await r.json();
                    const row = {
                        Name: data.name,
                        Email: data.email,
                        Organization: data.organization,
                        Q1: data.answers.q1,
                        Q2: data.answers.q2,
                        Q3: data.answers.q3,
                        Q4: data.answers.q4,
                        Q5: data.answers.q5,
                        SubmittedAt: data.submittedAt
                    };
                    answers.push(row);
                }
            } catch (e) {
                console.error('Failed to load ' + file.name, e);
            }
        }

        // 3. Create Excel
        const worksheet = XLSX.utils.json_to_sheet(answers);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Survey Responses");
        
        // 4. Download
        XLSX.writeFile(workbook, "survey_responses.xlsx");
        status.textContent = 'ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!';

      } catch (err) {
        console.error(err);
        status.textContent = 'ì—‘ì…€ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
      }
    });

    // ì´ˆê¸° ë¡œë“œ
    loadContent();
    loadSurveyStats();
  </script>
</body>
</html>
